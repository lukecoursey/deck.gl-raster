!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@deck.gl/layers"),require("@luma.gl/engine"),require("@luma.gl/core"),require("@luma.gl/constants"),require("@deck.gl/mesh-layers"),require("@deck.gl/core")):"function"==typeof define&&define.amd?define(["exports","@deck.gl/layers","@luma.gl/engine","@luma.gl/core","@luma.gl/constants","@deck.gl/mesh-layers","@deck.gl/core"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).deck=e.deck||{},e.deck["gl-raster"]={}),e.deck,e.luma,e.luma,e.luma.GL,e.deck,e.deck)}(this,(function(e,t,o,a,r,n,i){"use strict";function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=s(r),l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var m=function(e){var t={exports:{}};return e(t,t.exports),t.exports}((function(e,t){var o="[object Arguments]",a="[object Map]",r="[object Object]",n="[object Set]",i=/^\[object .+?Constructor\]$/,s=/^(?:0|[1-9]\d*)$/,c={};c["[object Float32Array]"]=c["[object Float64Array]"]=c["[object Int8Array]"]=c["[object Int16Array]"]=c["[object Int32Array]"]=c["[object Uint8Array]"]=c["[object Uint8ClampedArray]"]=c["[object Uint16Array]"]=c["[object Uint32Array]"]=!0,c[o]=c["[object Array]"]=c["[object ArrayBuffer]"]=c["[object Boolean]"]=c["[object DataView]"]=c["[object Date]"]=c["[object Error]"]=c["[object Function]"]=c[a]=c["[object Number]"]=c[r]=c["[object RegExp]"]=c[n]=c["[object String]"]=c["[object WeakMap]"]=!1;var m="object"==typeof l&&l&&l.Object===Object&&l,u="object"==typeof self&&self&&self.Object===Object&&self,f=m||u||Function("return this")(),p=t&&!t.nodeType&&t,d=p&&e&&!e.nodeType&&e,g=d&&d.exports===p,_=g&&m.process,v=function(){try{return _&&_.binding&&_.binding("util")}catch(e){}}(),h=v&&v.isTypedArray;function y(e,t){for(var o=-1,a=null==e?0:e.length;++o<a;)if(t(e[o],o,e))return!0;return!1}function b(e){var t=-1,o=Array(e.size);return e.forEach((function(e,a){o[++t]=[a,e]})),o}function E(e){var t=-1,o=Array(e.size);return e.forEach((function(e){o[++t]=e})),o}var C,T,x,L=Array.prototype,R=Function.prototype,P=Object.prototype,A=f["__core-js_shared__"],O=R.toString,S=P.hasOwnProperty,D=(C=/[^.]+$/.exec(A&&A.keys&&A.keys.IE_PROTO||""))?"Symbol(src)_1."+C:"",I=P.toString,j=RegExp("^"+O.call(S).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),M=g?f.Buffer:void 0,w=f.Symbol,G=f.Uint8Array,U=P.propertyIsEnumerable,F=L.splice,N=w?w.toStringTag:void 0,z=Object.getOwnPropertySymbols,k=M?M.isBuffer:void 0,K=(T=Object.keys,x=Object,function(e){return T(x(e))}),V=ve(f,"DataView"),Y=ve(f,"Map"),B=ve(f,"Promise"),W=ve(f,"Set"),H=ve(f,"WeakMap"),q=ve(Object,"create"),Z=Ee(V),$=Ee(Y),X=Ee(B),J=Ee(W),Q=Ee(H),ee=w?w.prototype:void 0,te=ee?ee.valueOf:void 0;function oe(e){var t=-1,o=null==e?0:e.length;for(this.clear();++t<o;){var a=e[t];this.set(a[0],a[1])}}function ae(e){var t=-1,o=null==e?0:e.length;for(this.clear();++t<o;){var a=e[t];this.set(a[0],a[1])}}function re(e){var t=-1,o=null==e?0:e.length;for(this.clear();++t<o;){var a=e[t];this.set(a[0],a[1])}}function ne(e){var t=-1,o=null==e?0:e.length;for(this.__data__=new re;++t<o;)this.add(e[t])}function ie(e){var t=this.__data__=new ae(e);this.size=t.size}function se(e,t){var o=xe(e),a=!o&&Te(e),r=!o&&!a&&Le(e),n=!o&&!a&&!r&&Se(e),i=o||a||r||n,s=i?function(e,t){for(var o=-1,a=Array(e);++o<e;)a[o]=t(o);return a}(e.length,String):[],c=s.length;for(var l in e)!t&&!S.call(e,l)||i&&("length"==l||r&&("offset"==l||"parent"==l)||n&&("buffer"==l||"byteLength"==l||"byteOffset"==l)||be(l,c))||s.push(l);return s}function ce(e,t){for(var o=e.length;o--;)if(Ce(e[o][0],t))return o;return-1}function le(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":N&&N in Object(e)?function(e){var t=S.call(e,N),o=e[N];try{e[N]=void 0;var a=!0}catch(e){}var r=I.call(e);a&&(t?e[N]=o:delete e[N]);return r}(e):function(e){return I.call(e)}(e)}function me(e){return Oe(e)&&le(e)==o}function ue(e,t,i,s,c){return e===t||(null==e||null==t||!Oe(e)&&!Oe(t)?e!=e&&t!=t:function(e,t,i,s,c,l){var m=xe(e),u=xe(t),f=m?"[object Array]":ye(e),p=u?"[object Array]":ye(t),d=(f=f==o?r:f)==r,g=(p=p==o?r:p)==r,_=f==p;if(_&&Le(e)){if(!Le(t))return!1;m=!0,d=!1}if(_&&!d)return l||(l=new ie),m||Se(e)?de(e,t,i,s,c,l):function(e,t,o,r,i,s,c){switch(o){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!s(new G(e),new G(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return Ce(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case a:var l=b;case n:var m=1&r;if(l||(l=E),e.size!=t.size&&!m)return!1;var u=c.get(e);if(u)return u==t;r|=2,c.set(e,t);var f=de(l(e),l(t),r,i,s,c);return c.delete(e),f;case"[object Symbol]":if(te)return te.call(e)==te.call(t)}return!1}(e,t,f,i,s,c,l);if(!(1&i)){var v=d&&S.call(e,"__wrapped__"),h=g&&S.call(t,"__wrapped__");if(v||h){var y=v?e.value():e,C=h?t.value():t;return l||(l=new ie),c(y,C,i,s,l)}}if(!_)return!1;return l||(l=new ie),function(e,t,o,a,r,n){var i=1&o,s=ge(e),c=s.length,l=ge(t).length;if(c!=l&&!i)return!1;var m=c;for(;m--;){var u=s[m];if(!(i?u in t:S.call(t,u)))return!1}var f=n.get(e);if(f&&n.get(t))return f==t;var p=!0;n.set(e,t),n.set(t,e);var d=i;for(;++m<c;){u=s[m];var g=e[u],_=t[u];if(a)var v=i?a(_,g,u,t,e,n):a(g,_,u,e,t,n);if(!(void 0===v?g===_||r(g,_,o,a,n):v)){p=!1;break}d||(d="constructor"==u)}if(p&&!d){var h=e.constructor,y=t.constructor;h==y||!("constructor"in e)||!("constructor"in t)||"function"==typeof h&&h instanceof h&&"function"==typeof y&&y instanceof y||(p=!1)}return n.delete(e),n.delete(t),p}(e,t,i,s,c,l)}(e,t,i,s,ue,c))}function fe(e){return!(!Ae(e)||function(e){return!!D&&D in e}(e))&&(Re(e)?j:i).test(Ee(e))}function pe(e){if(o=(t=e)&&t.constructor,a="function"==typeof o&&o.prototype||P,t!==a)return K(e);var t,o,a,r=[];for(var n in Object(e))S.call(e,n)&&"constructor"!=n&&r.push(n);return r}function de(e,t,o,a,r,n){var i=1&o,s=e.length,c=t.length;if(s!=c&&!(i&&c>s))return!1;var l=n.get(e);if(l&&n.get(t))return l==t;var m=-1,u=!0,f=2&o?new ne:void 0;for(n.set(e,t),n.set(t,e);++m<s;){var p=e[m],d=t[m];if(a)var g=i?a(d,p,m,t,e,n):a(p,d,m,e,t,n);if(void 0!==g){if(g)continue;u=!1;break}if(f){if(!y(t,(function(e,t){if(i=t,!f.has(i)&&(p===e||r(p,e,o,a,n)))return f.push(t);var i}))){u=!1;break}}else if(p!==d&&!r(p,d,o,a,n)){u=!1;break}}return n.delete(e),n.delete(t),u}function ge(e){return function(e,t,o){var a=t(e);return xe(e)?a:function(e,t){for(var o=-1,a=t.length,r=e.length;++o<a;)e[r+o]=t[o];return e}(a,o(e))}(e,De,he)}function _e(e,t){var o,a,r=e.__data__;return("string"==(a=typeof(o=t))||"number"==a||"symbol"==a||"boolean"==a?"__proto__"!==o:null===o)?r["string"==typeof t?"string":"hash"]:r.map}function ve(e,t){var o=function(e,t){return null==e?void 0:e[t]}(e,t);return fe(o)?o:void 0}oe.prototype.clear=function(){this.__data__=q?q(null):{},this.size=0},oe.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},oe.prototype.get=function(e){var t=this.__data__;if(q){var o=t[e];return"__lodash_hash_undefined__"===o?void 0:o}return S.call(t,e)?t[e]:void 0},oe.prototype.has=function(e){var t=this.__data__;return q?void 0!==t[e]:S.call(t,e)},oe.prototype.set=function(e,t){var o=this.__data__;return this.size+=this.has(e)?0:1,o[e]=q&&void 0===t?"__lodash_hash_undefined__":t,this},ae.prototype.clear=function(){this.__data__=[],this.size=0},ae.prototype.delete=function(e){var t=this.__data__,o=ce(t,e);return!(o<0)&&(o==t.length-1?t.pop():F.call(t,o,1),--this.size,!0)},ae.prototype.get=function(e){var t=this.__data__,o=ce(t,e);return o<0?void 0:t[o][1]},ae.prototype.has=function(e){return ce(this.__data__,e)>-1},ae.prototype.set=function(e,t){var o=this.__data__,a=ce(o,e);return a<0?(++this.size,o.push([e,t])):o[a][1]=t,this},re.prototype.clear=function(){this.size=0,this.__data__={hash:new oe,map:new(Y||ae),string:new oe}},re.prototype.delete=function(e){var t=_e(this,e).delete(e);return this.size-=t?1:0,t},re.prototype.get=function(e){return _e(this,e).get(e)},re.prototype.has=function(e){return _e(this,e).has(e)},re.prototype.set=function(e,t){var o=_e(this,e),a=o.size;return o.set(e,t),this.size+=o.size==a?0:1,this},ne.prototype.add=ne.prototype.push=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this},ne.prototype.has=function(e){return this.__data__.has(e)},ie.prototype.clear=function(){this.__data__=new ae,this.size=0},ie.prototype.delete=function(e){var t=this.__data__,o=t.delete(e);return this.size=t.size,o},ie.prototype.get=function(e){return this.__data__.get(e)},ie.prototype.has=function(e){return this.__data__.has(e)},ie.prototype.set=function(e,t){var o=this.__data__;if(o instanceof ae){var a=o.__data__;if(!Y||a.length<199)return a.push([e,t]),this.size=++o.size,this;o=this.__data__=new re(a)}return o.set(e,t),this.size=o.size,this};var he=z?function(e){return null==e?[]:(e=Object(e),function(e,t){for(var o=-1,a=null==e?0:e.length,r=0,n=[];++o<a;){var i=e[o];t(i,o,e)&&(n[r++]=i)}return n}(z(e),(function(t){return U.call(e,t)})))}:function(){return[]},ye=le;function be(e,t){return!!(t=null==t?9007199254740991:t)&&("number"==typeof e||s.test(e))&&e>-1&&e%1==0&&e<t}function Ee(e){if(null!=e){try{return O.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function Ce(e,t){return e===t||e!=e&&t!=t}(V&&"[object DataView]"!=ye(new V(new ArrayBuffer(1)))||Y&&ye(new Y)!=a||B&&"[object Promise]"!=ye(B.resolve())||W&&ye(new W)!=n||H&&"[object WeakMap]"!=ye(new H))&&(ye=function(e){var t=le(e),o=t==r?e.constructor:void 0,i=o?Ee(o):"";if(i)switch(i){case Z:return"[object DataView]";case $:return a;case X:return"[object Promise]";case J:return n;case Q:return"[object WeakMap]"}return t});var Te=me(function(){return arguments}())?me:function(e){return Oe(e)&&S.call(e,"callee")&&!U.call(e,"callee")},xe=Array.isArray;var Le=k||function(){return!1};function Re(e){if(!Ae(e))return!1;var t=le(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}function Pe(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}function Ae(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function Oe(e){return null!=e&&"object"==typeof e}var Se=h?function(e){return function(t){return e(t)}}(h):function(e){return Oe(e)&&Pe(e.length)&&!!c[le(e)]};function De(e){return null!=(t=e)&&Pe(t.length)&&!Re(t)?se(e):pe(e);var t}e.exports=function(e,t){return ue(e,t)}}));const u={[c.default.TEXTURE_MIN_FILTER]:c.default.NEAREST,[c.default.TEXTURE_MAG_FILTER]:c.default.NEAREST,[c.default.TEXTURE_WRAP_S]:c.default.CLAMP_TO_EDGE,[c.default.TEXTURE_WRAP_T]:c.default.CLAMP_TO_EDGE};function f({gl:e,images:t,props:o,oldProps:a}){let r=!1;if(a&&a.images)for(const e in a.images)o.images&&!(e in o.images)&&e in t&&(delete t[e],r=!0);const n=[];for(const e in o.images)!a.images||a.images&&!(e in a.images)?n.push(e):m(o.images[e],a.images[e])||n.push(e);for(const a of n){const n=o.images[a];n&&(Array.isArray(n)?t[a]=n.map(t=>p(e,t)):t[a]=p(e,n),r=!0)}return r?t:null}function p(e,t){if(!t)return null;if(t instanceof a.Texture2D)return t;let o={...t,parameters:{...u,...t.parameters}};return a.isWebGL2(e)||(o=function(e){e.mipmaps=!1,[c.default.R8UI,c.default.R16UI,c.default.R32UI].includes(e.format)&&(e.format=c.default.LUMINANCE);e.dataFormat===c.default.RED_INTEGER&&(e.dataFormat=c.default.LUMINANCE);[c.default.UNSIGNED_BYTE,c.default.UNSIGNED_SHORT,c.default.UNSIGNED_INT].includes(e.type)&&(e.type=c.default.FLOAT);(e.data instanceof Uint8Array||e.data instanceof Uint16Array||e.data instanceof Uint32Array)&&(e.data=new Float32Array(e.data));return e}(o)),new a.Texture2D(e,o)}const d={...t.BitmapLayer.defaultProps,modules:{type:"array",value:[],compare:!0},images:{type:"object",value:{},compare:!0},moduleProps:{type:"object",value:{},compare:!0}};class g extends t.BitmapLayer{initializeState(){const{gl:e}=this.context,t=o.ProgramManager.getDefaultProgramManager(e),a="fs:DECKGL_MUTATE_COLOR(inout vec4 image, in vec2 coord)",r="fs:DECKGL_CREATE_COLOR(inout vec4 image, in vec2 coord)";t._hookFunctions.includes(a)||t.addShaderHook(a),t._hookFunctions.includes(r)||t.addShaderHook(r),this.setState({images:{}}),super.initializeState()}draw({uniforms:e}){const{model:t,images:o,coordinateConversion:a,bounds:r}=this.state,{desaturate:n,transparentColor:i,tintColor:s,moduleProps:c}=this.props;t&&o&&0!==Object.keys(o).length&&Object.values(o).every(e=>e)&&t.setUniforms(Object.assign({},e,{desaturate:n,transparentColor:i.map(e=>e/255),tintColor:s.slice(0,3).map(e=>e/255),coordinateConversion:a,bounds:r})).updateModuleSettings({...c,...o}).draw()}getShaders(){const{gl:e}=this.context,{modules:t=[]}=this.props,o=a.isWebGL2(e);for(const e of t)e.fs=o?e.fs2||e.fs:e.fs1||e.fs,!o&&e.defines&&(e.defines.SAMPLER_TYPE="sampler2D");const r=super.getShaders();return{...r,vs:o?"#version 300 es\n#define SHADER_NAME raster-layer-vertex-shader\nin vec2 texCoords;in vec3 positions;in vec3 positions64Low;out vec2 vTexCoord;out vec2 vTexPos;uniform mediump float coordinateConversion;const vec3 pickingColor=vec3(1.0,0.0,0.0);void main(void){geometry.worldPosition=positions;geometry.uv=texCoords;geometry.pickingColor=pickingColor;gl_Position=project_position_to_clipspace(positions,positions64Low,vec3(0.0),geometry.position);DECKGL_FILTER_GL_POSITION(gl_Position,geometry);vTexCoord=texCoords;if(coordinateConversion<-0.5){vTexPos=geometry.position.xy;}else if(coordinateConversion>0.5){vTexPos=geometry.worldPosition.xy;}vec4 color=vec4(0.0);DECKGL_FILTER_COLOR(color,geometry);}":"#define SHADER_NAME raster-layer-vertex-shader\nattribute vec2 texCoords;attribute vec3 positions;attribute vec3 positions64Low;varying vec2 vTexCoord;varying vec2 vTexPos;uniform mediump float coordinateConversion;const vec3 pickingColor=vec3(1.0,0.0,0.0);void main(void){geometry.worldPosition=positions;geometry.uv=texCoords;geometry.pickingColor=pickingColor;gl_Position=project_position_to_clipspace(positions,positions64Low,vec3(0.0),geometry.position);DECKGL_FILTER_GL_POSITION(gl_Position,geometry);vTexCoord=texCoords;if(coordinateConversion<-0.5){vTexPos=geometry.position.xy;}else if(coordinateConversion>0.5){vTexPos=geometry.worldPosition.xy;}vec4 color=vec4(0.0);DECKGL_FILTER_COLOR(color,geometry);}",fs:o?"#version 300 es\n#define SHADER_NAME raster-layer-fragment-shader\nprecision mediump float;precision mediump int;precision mediump usampler2D;in vec2 vTexCoord;in vec2 vTexPos;out vec4 color;uniform float desaturate;uniform vec4 transparentColor;uniform vec3 tintColor;uniform float opacity;uniform mediump float coordinateConversion;uniform vec4 bounds;const float TILE_SIZE=512.0;const float PI=3.1415926536;const float WORLD_SCALE=TILE_SIZE/PI/2.0;vec2 lnglat_to_mercator(vec2 lnglat){float x=lnglat.x;float y=clamp(lnglat.y,-89.9,89.9);return vec2(radians(x)+PI,PI+log(tan(PI*0.25+radians(y)*0.5)))*WORLD_SCALE;}vec2 mercator_to_lnglat(vec2 xy){xy/=WORLD_SCALE;return degrees(vec2(xy.x-PI,atan(exp(xy.y-PI))*2.0-PI*0.5));}vec3 color_desaturate(vec3 color){float luminance=(color.r+color.g+color.b)*0.333333333;return mix(color,vec3(luminance),desaturate);}vec3 color_tint(vec3 color){return color*tintColor;}vec4 apply_opacity(vec3 color,float alpha){return mix(transparentColor,vec4(color,1.0),alpha);}vec2 getUV(vec2 pos){return vec2((pos.x-bounds[0])/(bounds[2]-bounds[0]),(pos.y-bounds[3])/(bounds[1]-bounds[3]));}void main(void){vec2 uv=vTexCoord;if(coordinateConversion<-0.5){vec2 lnglat=mercator_to_lnglat(vTexPos);uv=getUV(lnglat);}else if(coordinateConversion>0.5){vec2 commonPos=lnglat_to_mercator(vTexPos);uv=getUV(commonPos);}vec4 image;DECKGL_CREATE_COLOR(image,uv);DECKGL_MUTATE_COLOR(image,uv);color=apply_opacity(color_tint(color_desaturate(image.rgb)),image.a*opacity);geometry.uv=uv;DECKGL_FILTER_COLOR(color,geometry);}":"#define SHADER_NAME raster-layer-fragment-shader\n#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec2 vTexCoord;varying vec2 vTexPos;uniform float desaturate;uniform vec4 transparentColor;uniform vec3 tintColor;uniform float opacity;uniform mediump float coordinateConversion;uniform vec4 bounds;const float TILE_SIZE=512.0;const float PI=3.1415926536;const float WORLD_SCALE=TILE_SIZE/PI/2.0;vec2 lnglat_to_mercator(vec2 lnglat){float x=lnglat.x;float y=clamp(lnglat.y,-89.9,89.9);return vec2(radians(x)+PI,PI+log(tan(PI*0.25+radians(y)*0.5)))*WORLD_SCALE;}vec2 mercator_to_lnglat(vec2 xy){xy/=WORLD_SCALE;return degrees(vec2(xy.x-PI,atan(exp(xy.y-PI))*2.0-PI*0.5));}vec3 color_desaturate(vec3 color){float luminance=(color.r+color.g+color.b)*0.333333333;return mix(color,vec3(luminance),desaturate);}vec3 color_tint(vec3 color){return color*tintColor;}vec4 apply_opacity(vec3 color,float alpha){return mix(transparentColor,vec4(color,1.0),alpha);}vec2 getUV(vec2 pos){return vec2((pos.x-bounds[0])/(bounds[2]-bounds[0]),(pos.y-bounds[3])/(bounds[1]-bounds[3]));}void main(void){vec2 uv=vTexCoord;if(coordinateConversion<-0.5){vec2 lnglat=mercator_to_lnglat(vTexPos);uv=getUV(lnglat);}else if(coordinateConversion>0.5){vec2 commonPos=lnglat_to_mercator(vTexPos);uv=getUV(commonPos);}vec4 image;DECKGL_CREATE_COLOR(image,uv);DECKGL_MUTATE_COLOR(image,uv);gl_FragColor=apply_opacity(color_tint(color_desaturate(image.rgb)),image.a*opacity);geometry.uv=uv;DECKGL_FILTER_COLOR(gl_FragColor,geometry);}",modules:[...r.modules,...t]}}updateState({props:e,oldProps:t,changeFlags:o}){const a=e&&e.modules&&t&&!m(e.modules,t.modules);if(o.extensionsChanged||a){const{gl:e}=this.context;this.state.model&&this.state.model.delete(),this.setState({model:this._getModel(e)}),this.getAttributeManager().invalidateAll()}e&&e.images&&this.updateImages({props:e,oldProps:t});const r=this.getAttributeManager();if(e.bounds!==t.bounds){const e=this.state.mesh,t=this._createMesh();this.state.model.setVertexCount(t.vertexCount);for(const o in t)e&&e[o]!==t[o]&&r.invalidate(o);this.setState({mesh:t,...this._getCoordinateUniforms()})}else e._imageCoordinateSystem!==t._imageCoordinateSystem&&this.setState(this._getCoordinateUniforms())}updateImages({props:e,oldProps:t}){const{images:o}=this.state,{gl:a}=this.context,r=f({gl:a,images:o,props:e,oldProps:t});r&&this.setState({images:r})}finalizeState(){if(super.finalizeState(),this.state.images)for(const e of Object.values(this.state.images))Array.isArray(e)?e.map(e=>e&&e.delete()):e&&e.delete()}}function _(e,t){return t===i.COORDINATE_SYSTEM.CARTESIAN||t===i.COORDINATE_SYSTEM.METER_OFFSETS||t===i.COORDINATE_SYSTEM.DEFAULT&&!e.isGeospatial}g.defaultProps=d,g.layerName="RasterLayer";function v(e){i.log.assert(e.positions||e.POSITION,'RasterMeshLayer requires "postions" or "POSITION" attribute in mesh property.')}function h(e){if(e.attributes)return v(e.attributes),e instanceof a.Geometry?e:new a.Geometry(e);if(e.positions||e.POSITION)return v(e),new a.Geometry({attributes:e});throw Error("Invalid mesh")}const y={...n.SimpleMeshLayer.defaultProps,modules:{type:"array",value:[],compare:!0},images:{type:"object",value:{},compare:!0},moduleProps:{type:"object",value:{},compare:!0}};class b extends n.SimpleMeshLayer{initializeState(){const{gl:e}=this.context,t=o.ProgramManager.getDefaultProgramManager(e),a="fs:DECKGL_MUTATE_COLOR(inout vec4 image, in vec2 coord)",r="fs:DECKGL_CREATE_COLOR(inout vec4 image, in vec2 coord)";t._hookFunctions.includes(a)||t.addShaderHook(a),t._hookFunctions.includes(r)||t.addShaderHook(r),this.setState({images:{}}),super.initializeState()}getShaders(){const{gl:e}=this.context,{modules:t=[]}=this.props,o=a.isWebGL2(e);for(const e of t)e.fs=o?e.fs2||e.fs:e.fs1||e.fs,!o&&e.defines&&(e.defines.SAMPLER_TYPE="sampler2D");return{...super.getShaders(),vs:o?"#version 300 es\n#define SHADER_NAME raster-mesh-layer-vs\nuniform float sizeScale;uniform bool composeModelMatrix;in vec3 positions;in vec3 normals;in vec3 colors;in vec2 texCoords;in vec3 instancePositions;in vec3 instancePositions64Low;in vec4 instanceColors;in vec3 instancePickingColors;in mat3 instanceModelMatrix;in vec3 instanceTranslation;out vec2 vTexCoord;out vec3 cameraPosition;out vec3 normals_commonspace;out vec4 position_commonspace;out vec4 vColor;void main(void){geometry.worldPosition=instancePositions;geometry.uv=texCoords;geometry.pickingColor=instancePickingColors;vTexCoord=texCoords;cameraPosition=project_uCameraPosition;normals_commonspace=project_normal(instanceModelMatrix*normals);vColor=vec4(colors*instanceColors.rgb,instanceColors.a);geometry.normal=normals_commonspace;vec3 pos=(instanceModelMatrix*positions)*sizeScale+instanceTranslation;if(composeModelMatrix){DECKGL_FILTER_SIZE(pos,geometry);gl_Position=project_position_to_clipspace(pos+instancePositions,instancePositions64Low,vec3(0.0),position_commonspace);}else{pos=project_size(pos);DECKGL_FILTER_SIZE(pos,geometry);gl_Position=project_position_to_clipspace(instancePositions,instancePositions64Low,pos,position_commonspace);}geometry.position=position_commonspace;DECKGL_FILTER_GL_POSITION(gl_Position,geometry);DECKGL_FILTER_COLOR(vColor,geometry);}":"#define SHADER_NAME raster-mesh-layer-vs\nuniform float sizeScale;uniform bool composeModelMatrix;attribute vec3 positions;attribute vec3 normals;attribute vec3 colors;attribute vec2 texCoords;attribute vec3 instancePositions;attribute vec3 instancePositions64Low;attribute vec4 instanceColors;attribute vec3 instancePickingColors;attribute mat3 instanceModelMatrix;attribute vec3 instanceTranslation;varying vec2 vTexCoord;varying vec3 cameraPosition;varying vec3 normals_commonspace;varying vec4 position_commonspace;varying vec4 vColor;void main(void){geometry.worldPosition=instancePositions;geometry.uv=texCoords;geometry.pickingColor=instancePickingColors;vTexCoord=texCoords;cameraPosition=project_uCameraPosition;normals_commonspace=project_normal(instanceModelMatrix*normals);vColor=vec4(colors*instanceColors.rgb,instanceColors.a);geometry.normal=normals_commonspace;vec3 pos=(instanceModelMatrix*positions)*sizeScale+instanceTranslation;if(composeModelMatrix){DECKGL_FILTER_SIZE(pos,geometry);gl_Position=project_position_to_clipspace(pos+instancePositions,instancePositions64Low,vec3(0.0),position_commonspace);}else{pos=project_size(pos);DECKGL_FILTER_SIZE(pos,geometry);gl_Position=project_position_to_clipspace(instancePositions,instancePositions64Low,pos,position_commonspace);}geometry.position=position_commonspace;DECKGL_FILTER_GL_POSITION(gl_Position,geometry);DECKGL_FILTER_COLOR(vColor,geometry);}",fs:o?"#version 300 es\n#define SHADER_NAME raster-mesh-layer-fs\nprecision highp float;uniform bool hasTexture;uniform bool flatShading;uniform float opacity;in vec2 vTexCoord;in vec3 cameraPosition;in vec3 normals_commonspace;in vec4 position_commonspace;in vec4 vColor;out vec4 fragColor;void main(void){geometry.uv=vTexCoord;vec4 image;DECKGL_CREATE_COLOR(image,vTexCoord);DECKGL_MUTATE_COLOR(image,vTexCoord);vec3 normal;if(flatShading){\n#ifdef DERIVATIVES_AVAILABLE\nnormal=normalize(cross(dFdx(position_commonspace.xyz),dFdy(position_commonspace.xyz)));\n#else\nnormal=vec3(0.0,0.0,1.0);\n#endif\n}else{normal=normals_commonspace;}vec3 lightColor=lighting_getLightColor(image.rgb,cameraPosition,position_commonspace.xyz,normal);fragColor=vec4(lightColor,opacity);DECKGL_FILTER_COLOR(fragColor,geometry);}":"#define SHADER_NAME raster-mesh-layer-fs\nprecision highp float;uniform bool hasTexture;uniform bool flatShading;uniform float opacity;varying vec2 vTexCoord;varying vec3 cameraPosition;varying vec3 normals_commonspace;varying vec4 position_commonspace;varying vec4 vColor;void main(void){geometry.uv=vTexCoord;vec4 image;DECKGL_CREATE_COLOR(image,vTexCoord);DECKGL_MUTATE_COLOR(image,vTexCoord);vec3 normal;if(flatShading){\n#ifdef DERIVATIVES_AVAILABLE\nnormal=normalize(cross(dFdx(position_commonspace.xyz),dFdy(position_commonspace.xyz)));\n#else\nnormal=vec3(0.0,0.0,1.0);\n#endif\n}else{normal=normals_commonspace;}vec3 lightColor=lighting_getLightColor(image.rgb,cameraPosition,position_commonspace.xyz,normal);gl_FragColor=vec4(lightColor,opacity);DECKGL_FILTER_COLOR(gl_FragColor,geometry);}",modules:[i.project32,i.phongLighting,...t]}}updateState({props:e,oldProps:t,changeFlags:o}){if(super.updateState({props:e,oldProps:t,changeFlags:o}),e.mesh!==t.mesh||o.extensionsChanged||e.modules!==t.modules){if(this.state.model&&this.state.model.delete(),e.mesh){this.setState({model:this.getModel(e.mesh)});const t=e.mesh.attributes||e.mesh;this.setState({hasNormals:Boolean(t.NORMAL||t.normals)})}this.getAttributeManager().invalidateAll()}e&&e.images&&this.updateImages({props:e,oldProps:t}),this.state.model&&this.state.model.setDrawMode(this.props.wireframe?c.default.LINE_STRIP:c.default.TRIANGLES)}updateImages({props:e,oldProps:t}){const{images:o}=this.state,{gl:a}=this.context,r=f({gl:a,images:o,props:e,oldProps:t});r&&this.setState({images:r})}draw({uniforms:e}){const{model:t,images:o}=this.state,{moduleProps:a}=this.props;if(!t||!o||0===Object.keys(o).length||!Object.values(o).every(e=>e))return;const{viewport:r}=this.context,{sizeScale:n,coordinateSystem:i,_instanced:s}=this.props;t.setUniforms(Object.assign({},e,{sizeScale:n,composeModelMatrix:!s||_(r,i),flatShading:!this.state.hasNormals})).updateModuleSettings({...a,...o}).draw()}finalizeState(){if(super.finalizeState(),this.state.images)for(const e of Object.values(this.state.images))Array.isArray(e)?e.map(e=>e&&e.delete()):e&&e.delete()}getModel(e){const{gl:t}=this.context;return new a.Model(t,Object.assign({},this.getShaders(),{id:this.props.id,geometry:h(e),isInstanced:!0}))}}b.layerName="RasterMeshLayer",b.defaultProps=y;const E={uint8:{format:c.default.R8UI,dataFormat:c.default.RED_INTEGER,type:c.default.UNSIGNED_BYTE},uint16:{format:c.default.R16UI,dataFormat:c.default.RED_INTEGER,type:c.default.UNSIGNED_SHORT},uint32:{format:c.default.R32UI,dataFormat:c.default.RED_INTEGER,type:c.default.UNSIGNED_INT},int8:{format:c.default.R8I,dataFormat:c.default.RED_INTEGER,type:c.default.BYTE},int16:{format:c.default.R16I,dataFormat:c.default.RED_INTEGER,type:c.default.SHORT},int32:{format:c.default.R32I,dataFormat:c.default.RED_INTEGER,type:c.default.INT},float16:{format:c.default.R16F,dataFormat:c.default.RED,type:c.default.HALF_FLOAT},float32:{format:c.default.R32F,dataFormat:c.default.RED,type:c.default.FLOAT}};var C={name:"combine-bands",fs1:"uniform sampler2D bitmapTexture_r;\nuniform sampler2D bitmapTexture_g;\nuniform sampler2D bitmapTexture_b;\nuniform sampler2D bitmapTexture_a;\n",fs2:"precision mediump float;\nprecision mediump int;\nprecision mediump usampler2D;\n\n#ifdef SAMPLER_TYPE\n  uniform SAMPLER_TYPE bitmapTexture_r;\n  uniform SAMPLER_TYPE bitmapTexture_g;\n  uniform SAMPLER_TYPE bitmapTexture_b;\n  uniform SAMPLER_TYPE bitmapTexture_a;\n#else\n  uniform sampler2D bitmapTexture_r;\n  uniform sampler2D bitmapTexture_g;\n  uniform sampler2D bitmapTexture_b;\n  uniform sampler2D bitmapTexture_a;\n#endif\n",getUniforms:function(e={}){const{imageBands:t}=e;if(!t||0===t.length)return;const[o,a,r,n]=t;return{bitmapTexture_r:o,bitmapTexture_g:a,bitmapTexture_b:r,bitmapTexture_a:n}},defines:{SAMPLER_TYPE:"sampler2D"},inject:{"fs:DECKGL_CREATE_COLOR":"\n    float channel1 = float(texture2D(bitmapTexture_r, coord).r);\n    float channel2 = float(texture2D(bitmapTexture_g, coord).r);\n    float channel3 = float(texture2D(bitmapTexture_b, coord).r);\n    float channel4 = float(texture2D(bitmapTexture_a, coord).r);\n\n    image = vec4(channel1, channel2, channel3, channel4);\n    "}};var T={name:"rgba-image",fs1:"uniform sampler2D bitmapTexture_rgba;\n",fs2:"precision mediump float;\nprecision mediump int;\nprecision mediump usampler2D;\n\n#ifdef SAMPLER_TYPE\n  uniform SAMPLER_TYPE bitmapTexture_rgba;\n#else\n  uniform sampler2D bitmapTexture_rgba;\n#endif\n",getUniforms:function(e={}){const{imageRgba:t}=e;if(t)return{bitmapTexture_rgba:t}},defines:{SAMPLER_TYPE:"sampler2D"},inject:{"fs:DECKGL_CREATE_COLOR":"\n    image = vec4(texture2D(bitmapTexture_rgba, coord));\n    "}};var x={name:"mask-image",fs:"uniform sampler2D bitmapTexture_mask;\n",getUniforms:function(e={}){const{imageMask:t}=e;if(t)return{bitmapTexture_mask:t}},inject:{"fs:DECKGL_MUTATE_COLOR":"\n    float alpha = float(texture2D(bitmapTexture_mask, coord).a);\n    image = vec4(image.rgb, alpha);\n    "}};var L={name:"colormap",fs:"uniform sampler2D u_colormap_texture;uniform float colormapScaler;uniform float colormapOffset;vec4 colormap(sampler2D cmap,vec4 image,float scaler,float offset){vec2 uv=vec2(scaler*image.r+offset,0.5);return texture2D(cmap,uv);}",getUniforms:function(e={}){const{imageColormap:t,colormapScaler:o,colormapOffset:a}=e;if(t)return{u_colormap_texture:t,colormapScaler:Number.isFinite(o)?o:.5,colormapOffset:Number.isFinite(a)?a:.5}},inject:{"fs:DECKGL_MUTATE_COLOR":"\n    image = colormap(u_colormap_texture, image, colormapScaler, colormapOffset);\n    "}};var R={name:"linear_rescale",fs:"uniform float linearRescaleScaler;uniform float linearRescaleOffset;vec4 linear_rescale(vec4 arr,float scaler,float offset){return arr*scaler+offset;}",getUniforms:function(e={}){const{linearRescaleScaler:t,linearRescaleOffset:o}=e;if(t||o)return{linearRescaleScaler:t||1,linearRescaleOffset:o||0}},inject:{"fs:DECKGL_MUTATE_COLOR":"\n    image = linear_rescale(image, linearRescaleScaler, linearRescaleOffset);\n    "}};var P={name:"sigmoidal_contrast",fs:"#define epsilon 0.00000001\nuniform float sigmoidal_contrast;uniform float sigmoidal_bias;vec4 sigmoidalContrast(vec4 arr,float contrast,float bias){float alpha=bias;float beta=contrast;alpha=clamp(alpha,epsilon,alpha);if(beta>0.){vec4 numerator=1./(1.+exp(beta*(alpha-arr)))-1./(1.+exp(beta*alpha));float denominator=1./(1.+exp(beta*(alpha-1.)))-1./(1.+exp(beta*alpha));arr=numerator/denominator;}else if(beta<0.){arr=((beta*alpha)-log((1.0/((arr/(1.0+exp((beta*alpha)-beta)))-(arr/(1.0+exp(beta*alpha)))+(1.0/(1.0+exp(beta*alpha)))))-1.0))/beta;}return arr;}",getUniforms:function(e={}){const{sigmoidalContrast:t,sigmoidalBias:o}=e;if(t||o)return{sigmoidal_contrast:t||0,sigmoidal_bias:o||.5}},inject:{"fs:DECKGL_MUTATE_COLOR":"\n    image = sigmoidalContrast(image, sigmoidal_contrast, sigmoidal_bias);\n    "}};var A={name:"gamma_contrast",fs:"#define epsilon 0.00000001\nuniform float gamma_r;uniform float gamma_g;uniform float gamma_b;uniform float gamma_a;float gammaContrast(float arr,float g){g=clamp(g,epsilon,g);return pow(arr,1.0/g);}vec4 gammaContrast(vec4 arr,float gamma1,float gamma2,float gamma3,float gamma4){arr.r=gammaContrast(arr.r,gamma1);arr.g=gammaContrast(arr.g,gamma2);arr.b=gammaContrast(arr.b,gamma3);arr.a=gammaContrast(arr.a,gamma4);return arr;}",getUniforms:function(e={}){const{gammaValue:t,gammaR:o,gammaG:a,gammaB:r,gammaA:n}=e;if(t||o||a||r||n)return{gamma_r:o||1,gamma_g:a||1,gamma_b:r||1,gamma_a:n||1}},inject:{"fs:DECKGL_MUTATE_COLOR":"\n    image = gammaContrast(image, gamma_r, gamma_g, gamma_b, gamma_a);\n    "}};var O={name:"pansharpen_brovey",fs1:"uniform sampler2D bitmapTexture_pan;uniform float panWeight;float pansharpen_brovey_ratio(vec4 rgb,float pan,float weight){return pan/((rgb.r+rgb.g+rgb.b*weight)/(2.+weight));}vec4 pansharpen_brovey_calc(vec4 rgb,float pan,float weight){float ratio=pansharpen_brovey_ratio(rgb,pan,weight);return ratio*rgb;}",fs2:"precision mediump usampler2D;\n#ifdef SAMPLER_TYPE\nuniform SAMPLER_TYPE bitmapTexture_pan;\n#else\nuniform sampler2D bitmapTexture_pan;\n#endif\nuniform float panWeight;float pansharpen_brovey_ratio(vec4 rgb,float pan,float weight){return pan/((rgb.r+rgb.g+rgb.b*weight)/(2.+weight));}vec4 pansharpen_brovey_calc(vec4 rgb,float pan,float weight){float ratio=pansharpen_brovey_ratio(rgb,pan,weight);return ratio*rgb;}",defines:{SAMPLER_TYPE:"sampler2D"},getUniforms:function(e={}){const{imagePan:t,panWeight:o=.2}=e;if(t)return{bitmapTexture_pan:t,panWeight:o}},inject:{"fs:DECKGL_MUTATE_COLOR":"\n    float pan_band = float(texture2D(bitmapTexture_pan, coord).r);\n    image = pansharpen_brovey_calc(image, pan_band, panWeight);\n    "}},S={name:"enhanced_vegetation_index",fs:"float enhanced_vegetation_index_calc(vec4 image){float band5=image.r;float band4=image.g;float band2=image.b;float numerator=band5-band4;float denominator=band5+(6.*band4)-(7.5*band2)+1.;return 2.5*(numerator/denominator);}",inject:{"fs:DECKGL_MUTATE_COLOR":"\n    image = vec4(enhanced_vegetation_index_calc(image), 0., 0., 0.);\n    "}},D={name:"modified_soil_adjusted_vegetation_index",fs:"float modified_soil_adjusted_vegetation_index_calc(vec4 image){float band5=image.r;float band4=image.g;float to_sqrt=((2.*band5+1.)*(2.*band5+1.))-(8.*(band5-band4));return((2.*band5)+1.-sqrt(to_sqrt))/2.;}",inject:{"fs:DECKGL_MUTATE_COLOR":"\n    image = vec4(modified_soil_adjusted_vegetation_index_calc(image), 0., 0., 0.);\n    "}},I={name:"normalized_difference",fs:"float normalized_difference_calc(vec4 image){return((image.r-image.g)/(image.r+image.g));}",inject:{"fs:DECKGL_MUTATE_COLOR":"\n    image = vec4(normalized_difference_calc(image), 0., 0., 0.);\n    "}},j={name:"soil_adjusted_vegetation_index",fs:"float soil_adjusted_vegetation_index_calc(vec4 image){float band5=image.r;float band4=image.g;float numerator=band5-band4;float denominator=(band5+band4+0.5)*1.5;return numerator/denominator;}",inject:{"fs:DECKGL_MUTATE_COLOR":"\n    image = vec4(soil_adjusted_vegetation_index_calc(image), 0., 0., 0.);\n    "}},M={name:"vector_length",fs:"float vector_length_calc(vec4 image){return length(vec2(image.r,image.g));}",inject:{"fs:DECKGL_MUTATE_COLOR":"\n    image = vec4(vector_length_calc(image), 0., 0., 0.);\n    "}};const w=new Uint8Array([147,78,85,77,80,89]);const G=function(){const e=new Uint32Array([305419896]);return!(18==new Uint8Array(e.buffer,e.byteOffset,e.byteLength)[0])}(),U={u1:{name:"uint8",arrayConstructor:Uint8Array},i1:{name:"int8",arrayConstructor:Int8Array},u2:{name:"uint16",arrayConstructor:Uint16Array},i2:{name:"int16",arrayConstructor:Int16Array},u4:{name:"uint32",arrayConstructor:Int32Array},i4:{name:"int32",arrayConstructor:Int32Array},f4:{name:"float32",arrayConstructor:Float32Array},f8:{name:"float64",arrayConstructor:Float64Array}};e.RasterLayer=g,e.RasterMeshLayer=b,e.WEBGL2_DTYPES=E,e._parseNpy=function(e){if(!e)return null;const t=new DataView(e);(function(e,t){for(let o=0;o<e.length;o++)if(e[o]!==t[o])return!1;return!0})(new Uint8Array(e,0,6),w)||console.warn("NPY Magic not matched!");const o=t.getUint8(6);let a,r=8;o>=2?(a=t.getUint32(8,!0),r+=4):(a=t.getUint16(8,!0),r+=2);const n=new TextDecoder(o<=2?"latin1":"utf-8"),i=new Uint8Array(e,r,a),s=n.decode(i);r+=a;const c=JSON.parse(s.replace(/'/g,'"').replace("False","false").replace("(","[").replace(/,*\),*/g,"]")),l=c.descr,m=U[l.slice(1,3)];if(!m)return console.warn("Decoding of npy dtype not implemented: "+l),null;const u=new m.arrayConstructor(e,r);if(">"===l[0]&&G||"<"===l[0]&&!G)throw new Error("Data is wrong endianness, byte swapping not yet implemented.");return c&&c.fortran_order&&console.warn("Data is in Fortran order."),{dtype:m.name,data:u,header:c}},e.colormap=L,e.combineBands=C,e.enhancedVegetationIndex=S,e.gammaContrast=A,e.linearRescale=R,e.maskImage=x,e.modifiedSoilAdjustedVegetationIndex=D,e.normalizedDifference=I,e.pansharpenBrovey=O,e.rgbaImage=T,e.sigmoidalContrast=P,e.soilAdjustedVegetationIndex=j,e.vectorLength=M,Object.defineProperty(e,"__esModule",{value:!0})}));
